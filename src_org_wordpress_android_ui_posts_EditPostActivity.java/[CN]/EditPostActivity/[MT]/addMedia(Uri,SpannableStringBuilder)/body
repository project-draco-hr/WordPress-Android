{
  if (ssb != null && isPicasaImage(imageUri))   imageUri=downloadExternalImage(imageUri);
  Bitmap resizedBitmap=null;
  ImageHelper ih=new ImageHelper();
  Display display=getWindowManager().getDefaultDisplay();
  int width=display.getWidth();
  int height=display.getHeight();
  if (width > height)   width=height;
  Map<String,Object> mediaData=ih.getImageBytesForPath(imageUri.getEncodedPath(),EditPostActivity.this);
  if (mediaData == null) {
    return false;
  }
  BitmapFactory.Options opts=new BitmapFactory.Options();
  opts.inJustDecodeBounds=true;
  byte[] bytes=(byte[])mediaData.get("bytes");
  BitmapFactory.decodeByteArray(bytes,0,bytes.length,opts);
  float conversionFactor=0.25f;
  if (opts.outWidth > opts.outHeight)   conversionFactor=0.40f;
  byte[] finalBytes=ih.createThumbnail(bytes,String.valueOf((int)(width * conversionFactor)),(String)mediaData.get("orientation"),true);
  if (finalBytes == null) {
    return false;
  }
  resizedBitmap=BitmapFactory.decodeByteArray(finalBytes,0,finalBytes.length);
  if (ssb != null) {
    WPImageSpan is=new WPImageSpan(EditPostActivity.this,resizedBitmap,imageUri);
    setWPImageSpanWidth(imageUri,is);
    is.setTitle((String)mediaData.get("title"));
    is.setImageSource(imageUri);
    is.setVideo(imageUri.getEncodedPath().contains("video"));
    ssb.append(" ");
    ssb.setSpan(is,ssb.length() - 1,ssb.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    AlignmentSpan.Standard as=new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
    ssb.setSpan(as,ssb.length() - 1,ssb.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    ssb.append("\n");
  }
 else {
    int selectionStart=mContentEditText.getSelectionStart();
    mStyleStart=selectionStart;
    int selectionEnd=mContentEditText.getSelectionEnd();
    if (selectionStart > selectionEnd) {
      int temp=selectionEnd;
      selectionEnd=selectionStart;
      selectionStart=temp;
    }
    Editable s=mContentEditText.getText();
    WPImageSpan is=new WPImageSpan(EditPostActivity.this,resizedBitmap,imageUri);
    setWPImageSpanWidth(imageUri,is);
    is.setTitle((String)mediaData.get("title"));
    is.setImageSource(imageUri);
    if (imageUri.getEncodedPath().contains("video")) {
      is.setVideo(true);
    }
    int line=0, column=0;
    try {
      line=mContentEditText.getLayout().getLineForOffset(selectionStart);
      column=mContentEditText.getSelectionStart() - mContentEditText.getLayout().getLineStart(line);
    }
 catch (    Exception ex) {
    }
    WPImageSpan[] image_spans=s.getSpans(selectionStart,selectionEnd,WPImageSpan.class);
    if (image_spans.length != 0) {
      s.insert(selectionEnd,"\n\n");
      selectionStart=selectionStart + 2;
      selectionEnd=selectionEnd + 2;
    }
 else     if (column != 0) {
      s.insert(selectionEnd,"\n");
      selectionStart=selectionStart + 1;
      selectionEnd=selectionEnd + 1;
    }
    s.insert(selectionStart," ");
    s.setSpan(is,selectionStart,selectionEnd + 1,Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    AlignmentSpan.Standard as=new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
    s.setSpan(as,selectionStart,selectionEnd + 1,Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    s.insert(selectionEnd + 1,"\n\n");
    try {
      mContentEditText.setSelection(s.length());
    }
 catch (    Exception e) {
      e.printStackTrace();
    }
  }
  return true;
}
