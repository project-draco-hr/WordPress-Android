{
  if (context == null) {
    return false;
  }
  if (ssb != null && !MediaUtils.isInMediaStore(imageUri)) {
    imageUri=MediaUtils.downloadExternalMedia(context,imageUri);
  }
  if (imageUri == null) {
    return false;
  }
  Bitmap thumbnailBitmap;
  String mediaTitle;
  if (imageUri.toString().contains("video") && !MediaUtils.isInMediaStore(imageUri)) {
    thumbnailBitmap=BitmapFactory.decodeResource(context.getResources(),R.drawable.media_movieclip);
    mediaTitle=getResources().getString(R.string.video);
  }
 else {
    thumbnailBitmap=ImageUtils.getWPImageSpanThumbnailFromFilePath(context,imageUri.getEncodedPath(),getMaximumThumbnailWidthForEditor());
    if (thumbnailBitmap == null) {
      return false;
    }
    mediaTitle=ImageUtils.getTitleForWPImageSpan(context,imageUri.getEncodedPath());
  }
  WPEditImageSpan is=new WPEditImageSpan(context,thumbnailBitmap,imageUri);
  MediaFile mediaFile=is.getMediaFile();
  mediaFile.setPostID(getPost().getLocalTablePostId());
  mediaFile.setTitle(mediaTitle);
  mediaFile.setFilePath(is.getImageSource().toString());
  MediaUtils.setWPImageSpanWidth(context,imageUri,is);
  if (imageUri.getEncodedPath() != null) {
    mediaFile.setVideo(imageUri.getEncodedPath().contains("video"));
  }
  WordPress.wpDB.saveMediaFile(mediaFile);
  if (ssb != null) {
    ssb.append(" ");
    ssb.setSpan(is,ssb.length() - 1,ssb.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    AlignmentSpan.Standard as=new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
    ssb.setSpan(as,ssb.length() - 1,ssb.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    ssb.append("\n");
  }
 else {
    EditText contentEditText=mEditorFragment.getContentEditText();
    int selectionStart=contentEditText.getSelectionStart();
    int selectionEnd=contentEditText.getSelectionEnd();
    if (selectionStart > selectionEnd) {
      int temp=selectionEnd;
      selectionEnd=selectionStart;
      selectionStart=temp;
    }
    Editable s=contentEditText.getText();
    if (s == null)     return false;
    int line, column=0;
    if (contentEditText.getLayout() != null) {
      line=contentEditText.getLayout().getLineForOffset(selectionStart);
      column=contentEditText.getSelectionStart() - contentEditText.getLayout().getLineStart(line);
    }
    ImageSpan[] image_spans=s.getSpans(selectionStart,selectionEnd,WPImageSpan.class);
    if (image_spans.length != 0) {
      s.insert(selectionEnd,"\n\n");
      selectionStart=selectionStart + 2;
      selectionEnd=selectionEnd + 2;
    }
 else     if (column != 0) {
      s.insert(selectionEnd,"\n");
      selectionStart=selectionStart + 1;
      selectionEnd=selectionEnd + 1;
    }
    s.insert(selectionStart," ");
    s.setSpan(is,selectionStart,selectionEnd + 1,Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    AlignmentSpan.Standard as=new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
    s.setSpan(as,selectionStart,selectionEnd + 1,Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    s.insert(selectionEnd + 1,"\n\n");
  }
  if (getSupportActionBar() != null && !getSupportActionBar().isShowing()) {
    ((InputMethodManager)getSystemService(Context.INPUT_METHOD_SERVICE)).toggleSoftInput(InputMethodManager.SHOW_FORCED,InputMethodManager.HIDE_IMPLICIT_ONLY);
  }
  return true;
}
