{
  String content="";
  String finalThumbnailUrl=null;
  String finalImageUrl=null;
  if (mf.getFileName() != null) {
    XMLRPCClient client=new XMLRPCClient(post.getBlog().getUrl(),post.getBlog().getHttpuser(),post.getBlog().getHttppassword());
    String curImagePath="";
    curImagePath=mf.getFileName();
    boolean video=false;
    if (curImagePath.contains("video")) {
      video=true;
    }
    if (video) {
      String tempFileName="wp-" + System.currentTimeMillis();
      try {
        context.openFileOutput(tempFileName,Context.MODE_PRIVATE);
      }
 catch (      FileNotFoundException e) {
        error=getResources().getString(R.string.file_error_create);
        mediaError=true;
        return null;
      }
      File tempFile=context.getFileStreamPath(tempFileName);
      Uri videoUri=Uri.parse(curImagePath);
      File fVideo=null;
      String mimeType="", xRes="", yRes="";
      if (videoUri.toString().contains("content:")) {
        String[] projection;
        Uri imgPath;
        projection=new String[]{Video.Media._ID,Video.Media.DATA,Video.Media.MIME_TYPE,Video.Media.RESOLUTION};
        imgPath=videoUri;
        Cursor cur=context.getContentResolver().query(imgPath,projection,null,null,null);
        String thumbData="";
        if (cur.moveToFirst()) {
          int mimeTypeColumn, resolutionColumn, dataColumn;
          dataColumn=cur.getColumnIndex(Video.Media.DATA);
          mimeTypeColumn=cur.getColumnIndex(Video.Media.MIME_TYPE);
          resolutionColumn=cur.getColumnIndex(Video.Media.RESOLUTION);
          mf=new MediaFile();
          thumbData=cur.getString(dataColumn);
          mimeType=cur.getString(mimeTypeColumn);
          fVideo=new File(thumbData);
          mf.setFilePath(fVideo.getPath());
          String resolution=cur.getString(resolutionColumn);
          if (resolution != null) {
            String[] resx=resolution.split("x");
            xRes=resx[0];
            yRes=resx[1];
          }
 else {
            if (!post.getBlog().getMaxImageWidth().equals("Original Size")) {
              xRes=post.getBlog().getMaxImageWidth();
              yRes=String.valueOf(Math.round(Integer.valueOf(post.getBlog().getMaxImageWidth()) * 0.75));
            }
 else {
              xRes="640";
              yRes="480";
            }
          }
        }
      }
 else {
        fVideo=new File(videoUri.toString().replace("file://",""));
      }
      String imageTitle=fVideo.getName();
      HashMap<String,Object> m=new HashMap<String,Object>();
      m.put("name",imageTitle);
      m.put("type",mimeType);
      m.put("bits",mf);
      m.put("overwrite",true);
      Object[] params={1,post.getBlog().getUsername(),post.getBlog().getPassword(),m};
      Object result=null;
      try {
        result=(Object)client.callUploadFile("wp.uploadFile",params,tempFile);
      }
 catch (      XMLRPCException e) {
        error=context.getResources().getString(R.string.error_media_upload) + ": " + cleanXMLRPCErrorMessage(e.getMessage());
        return null;
      }
      HashMap<?,?> contentHash=new HashMap<Object,Object>();
      contentHash=(HashMap<?,?>)result;
      String resultURL=contentHash.get("url").toString();
      if (contentHash.containsKey("videopress_shortcode")) {
        resultURL=contentHash.get("videopress_shortcode").toString() + "\n";
      }
 else {
        resultURL=String.format("<video width=\"%s\" height=\"%s\" controls=\"controls\"><source src=\"%s\" type=\"%s\" /><a href=\"%s\">Click to view video</a>.</video>",xRes,yRes,resultURL,mimeType,resultURL);
      }
      content=content + resultURL;
    }
 else {
      for (int i=0; i < 2; i++) {
        String tempFileName="wp-" + System.currentTimeMillis();
        try {
          context.openFileOutput(tempFileName,Context.MODE_PRIVATE);
        }
 catch (        FileNotFoundException e) {
          mediaError=true;
          error=context.getString(R.string.file_not_found);
          return null;
        }
        File tempFile=context.getFileStreamPath(tempFileName);
        curImagePath=mf.getFileName();
        if (i == 0 || (((post.getBlog().isFullSizeImage() && !post.getBlog().getMaxImageWidth().equals("Original Size")) || post.getBlog().isScaledImage()))) {
          Uri imageUri=Uri.parse(curImagePath);
          File jpeg=null;
          String mimeType="", orientation="", path="";
          if (imageUri.toString().contains("content:")) {
            String[] projection;
            Uri imgPath;
            projection=new String[]{Images.Media._ID,Images.Media.DATA,Images.Media.MIME_TYPE,Images.Media.ORIENTATION};
            imgPath=imageUri;
            Cursor cur=context.getContentResolver().query(imgPath,projection,null,null,null);
            String thumbData="";
            if (cur.moveToFirst()) {
              int dataColumn, mimeTypeColumn, orientationColumn;
              dataColumn=cur.getColumnIndex(Images.Media.DATA);
              mimeTypeColumn=cur.getColumnIndex(Images.Media.MIME_TYPE);
              orientationColumn=cur.getColumnIndex(Images.Media.ORIENTATION);
              orientation=cur.getString(orientationColumn);
              thumbData=cur.getString(dataColumn);
              mimeType=cur.getString(mimeTypeColumn);
              jpeg=new File(thumbData);
              path=thumbData;
              mf.setFilePath(jpeg.getPath());
            }
          }
 else {
            path=imageUri.toString().replace("file://","");
            jpeg=new File(path);
            mf.setFilePath(path);
          }
          if (jpeg == null) {
            error=context.getString(R.string.file_not_found);
            mediaError=true;
            return null;
          }
          ImageHelper ih=new ImageHelper();
          orientation=ih.getExifOrientation(path,orientation);
          String imageTitle=jpeg.getName();
          byte[] finalBytes=null;
          if (i == 0 || post.getBlog().isScaledImage()) {
            byte[] bytes=new byte[(int)jpeg.length()];
            DataInputStream in=null;
            try {
              in=new DataInputStream(new FileInputStream(jpeg));
            }
 catch (            FileNotFoundException e) {
              e.printStackTrace();
            }
            try {
              in.readFully(bytes);
            }
 catch (            IOException e) {
              e.printStackTrace();
            }
            try {
              in.close();
            }
 catch (            IOException e) {
              e.printStackTrace();
            }
            String width=String.valueOf(i == 0 ? mf.getWidth() : post.getBlog().getScaledImageWidth());
            if (post.getBlog().getMaxImageWidth().equals("Original Size") && i == 0)             width="Original Size";
            ImageHelper ih2=new ImageHelper();
            finalBytes=ih2.createThumbnail(bytes,width,orientation,false);
            if (finalBytes == null) {
              error=context.getString(R.string.out_of_memory);
              mediaError=true;
              return null;
            }
          }
          Map<String,Object> m=new HashMap<String,Object>();
          m.put("name",imageTitle);
          m.put("type",mimeType);
          if (i == 0 || post.getBlog().isScaledImage()) {
            m.put("bits",finalBytes);
          }
 else {
            m.put("bits",mf);
          }
          m.put("overwrite",true);
          Object[] params={1,post.getBlog().getUsername(),post.getBlog().getPassword(),m};
          Object result=null;
          try {
            result=(Object)client.callUploadFile("wp.uploadFile",params,tempFile);
          }
 catch (          XMLRPCException e) {
            error=context.getResources().getString(R.string.error_media_upload) + ": " + cleanXMLRPCErrorMessage(e.getMessage());
            mediaError=true;
            return null;
          }
          HashMap<?,?> contentHash=new HashMap<Object,Object>();
          contentHash=(HashMap<?,?>)result;
          String resultURL=contentHash.get("url").toString();
          if (mf.isFeatured()) {
            try {
              if (contentHash.get("id") != null) {
                featuredImageID=Integer.parseInt(contentHash.get("id").toString());
                if (!mf.isFeaturedInPost())                 return "";
              }
            }
 catch (            NumberFormatException e) {
              e.printStackTrace();
            }
          }
          if (i == 0) {
            finalThumbnailUrl=resultURL;
          }
 else {
            if (post.getBlog().isFullSizeImage() || post.getBlog().isScaledImage()) {
              finalImageUrl=resultURL;
            }
 else {
              finalImageUrl="";
            }
          }
          String alignment="";
switch (mf.getHorizontalAlignment()) {
case 0:
            alignment="alignnone";
          break;
case 1:
        alignment="alignleft";
      break;
case 2:
    alignment="aligncenter";
  break;
case 3:
alignment="alignright";
break;
}
String alignmentCSS="class=\"" + alignment + " size-full\" ";
if (resultURL != null) {
if (i != 0 && (post.getBlog().isFullSizeImage() || post.getBlog().isScaledImage())) {
content=content + "<a href=\"" + finalImageUrl+ "\"><img title=\""+ mf.getTitle()+ "\" "+ alignmentCSS+ "alt=\"image\" src=\""+ finalThumbnailUrl+ "\" /></a>";
}
 else {
if (i == 0 && (post.getBlog().isFullSizeImage() == false && !post.getBlog().isScaledImage()) || (post.getBlog().getMaxImageWidth().equals("Original Size") && !post.getBlog().isScaledImage())) {
content=content + "<a href=\"" + finalThumbnailUrl+ "\"><img title=\""+ mf.getTitle()+ "\" "+ alignmentCSS+ "alt=\"image\" src=\""+ finalThumbnailUrl+ "\" /></a>";
}
}
if ((i == 0 && (!post.getBlog().isFullSizeImage() && !post.getBlog().isScaledImage()) || (post.getBlog().getMaxImageWidth().equals("Original Size") && !post.getBlog().isScaledImage())) || i == 1) {
if (!mf.getCaption().equals("")) {
content=String.format("[caption id=\"\" align=\"%s\" width=\"%d\" caption=\"%s\"]%s[/caption]",alignment,mf.getWidth(),EscapeUtils.escapeHtml(mf.getCaption()),content);
}
}
}
}
}
}
}
return content;
}
