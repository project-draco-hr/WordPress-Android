{
  long wpcomUserId=AccountHelper.getDefaultAccount().getUserId();
  String pushUserId=extras.getString(PUSH_ARG_USER);
  if (!String.valueOf(wpcomUserId).equals(pushUserId)) {
    AppLog.e(T.NOTIFS,"wpcom userId found in the app doesn't match with the ID in the PN. Aborting.");
    return;
  }
  String noteType=StringUtils.notNullStr(extras.getString(PUSH_ARG_TYPE));
  if (noteType.equals(PUSH_TYPE_PUSH_AUTH)) {
    handlePushAuth(context,extras);
    return;
  }
  String title=StringEscapeUtils.unescapeHtml(extras.getString(PUSH_ARG_TITLE));
  if (title == null) {
    title=getString(R.string.app_name);
  }
  String message=StringEscapeUtils.unescapeHtml(extras.getString(PUSH_ARG_MSG));
  String noteId=extras.getString(PUSH_ARG_NOTE_ID,"");
  long thisTime=System.currentTimeMillis();
  if (mPreviousNoteId != null && mPreviousNoteId.equals(noteId)) {
    long seconds=TimeUnit.MILLISECONDS.toSeconds(thisTime - mPreviousNoteTime);
    if (seconds <= 1) {
      AppLog.w(T.NOTIFS,"skipped potential duplicate notification");
      return;
    }
  }
  mPreviousNoteId=noteId;
  mPreviousNoteTime=thisTime;
  int pushId=0;
  for (  int id : mActiveNotificationsMap.keySet()) {
    Bundle noteBundle=mActiveNotificationsMap.get(id);
    if (noteBundle.getString(PUSH_ARG_NOTE_ID,"").equals(noteId)) {
      pushId=id;
      mActiveNotificationsMap.put(pushId,extras);
      break;
    }
  }
  if (pushId == 0) {
    pushId=PUSH_NOTIFICATION_ID + mActiveNotificationsMap.size();
    mActiveNotificationsMap.put(pushId,extras);
  }
  String iconUrl=extras.getString("icon");
  Bitmap largeIconBitmap=null;
  if (iconUrl != null) {
    try {
      iconUrl=URLDecoder.decode(iconUrl,"UTF-8");
      int largeIconSize=context.getResources().getDimensionPixelSize(android.R.dimen.notification_large_icon_height);
      String resizedUrl=PhotonUtils.getPhotonImageUrl(iconUrl,largeIconSize,largeIconSize);
      largeIconBitmap=ImageUtils.downloadBitmap(resizedUrl);
      if (largeIconBitmap != null && shouldCircularizeNoteIcon(noteType)) {
        largeIconBitmap=ImageUtils.getCircularBitmap(largeIconBitmap);
      }
    }
 catch (    UnsupportedEncodingException e) {
      AppLog.e(T.NOTIFS,e);
    }
  }
  Map<String,String> properties=new HashMap<>();
  if (!TextUtils.isEmpty(noteType)) {
    if (noteType.equals(PUSH_TYPE_COMMENT)) {
      properties.put("notification_type","comment");
    }
 else {
      properties.put("notification_type",noteType);
    }
  }
  AnalyticsTracker.track(Stat.PUSH_NOTIFICATION_RECEIVED,properties);
  NotificationCompat.Builder builder;
  builder=new NotificationCompat.Builder(this).setSmallIcon(R.drawable.notification_icon).setColor(getResources().getColor(R.color.blue_wordpress)).setContentTitle(title).setContentText(message).setTicker(message).setAutoCancel(true).setStyle(new NotificationCompat.BigTextStyle().bigText(message)).setGroup(NOTIFICATION_GROUP_KEY);
  if (noteType.equals(PUSH_TYPE_COMMENT)) {
    Intent commentReplyIntent=new Intent(this,WPMainActivity.class);
    commentReplyIntent.putExtra(WPMainActivity.ARG_OPENED_FROM_PUSH,true);
    commentReplyIntent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
    commentReplyIntent.setAction("android.intent.action.MAIN");
    commentReplyIntent.addCategory("android.intent.category.LAUNCHER");
    commentReplyIntent.addCategory("comment-reply");
    commentReplyIntent.putExtra(NotificationsListFragment.NOTE_INSTANT_REPLY_EXTRA,true);
    if (noteId != null) {
      commentReplyIntent.putExtra(NotificationsListFragment.NOTE_ID_EXTRA,noteId);
    }
    PendingIntent commentReplyPendingIntent=PendingIntent.getActivity(context,0,commentReplyIntent,PendingIntent.FLAG_CANCEL_CURRENT);
    builder.addAction(R.drawable.ic_reply_white_24dp,context.getText(R.string.reply),commentReplyPendingIntent);
  }
  if (largeIconBitmap != null) {
    builder.setLargeIcon(largeIconBitmap);
  }
  showNotificationForBuilder(builder,context,pushId);
  if (mActiveNotificationsMap.size() > 1) {
    NotificationCompat.InboxStyle inboxStyle=new NotificationCompat.InboxStyle();
    int noteCtr=1;
    for (    Bundle pushBundle : mActiveNotificationsMap.values()) {
      if (noteCtr > mMaxInboxItems) {
        break;
      }
      if (pushBundle.getString(PUSH_ARG_MSG) == null) {
        continue;
      }
      if (pushBundle.getString(PUSH_ARG_TYPE,"").equals(PUSH_TYPE_COMMENT)) {
        String pnTitle=StringEscapeUtils.unescapeHtml((pushBundle.getString(PUSH_ARG_TITLE)));
        String pnMessage=StringEscapeUtils.unescapeHtml((pushBundle.getString(PUSH_ARG_MSG)));
        inboxStyle.addLine(pnTitle + ": " + pnMessage);
      }
 else {
        String pnMessage=StringEscapeUtils.unescapeHtml((pushBundle.getString(PUSH_ARG_MSG)));
        inboxStyle.addLine(pnMessage);
      }
      noteCtr++;
    }
    if (mActiveNotificationsMap.size() > mMaxInboxItems) {
      inboxStyle.setSummaryText(String.format(getString(R.string.more_notifications),mActiveNotificationsMap.size() - mMaxInboxItems));
    }
    String subject=String.format(getString(R.string.new_notifications),mActiveNotificationsMap.size());
    NotificationCompat.Builder groupBuilder=new NotificationCompat.Builder(this).setSmallIcon(R.drawable.notification_icon).setColor(getResources().getColor(R.color.blue_wordpress)).setContentTitle(getString(R.string.app_name)).setContentText(subject).setGroup(NOTIFICATION_GROUP_KEY).setGroupSummary(true).setTicker(message).setAutoCancel(true).setStyle(inboxStyle);
    showNotificationForBuilder(groupBuilder,context,GROUP_NOTIFICATION_ID);
  }
  EventBus.getDefault().post(new NotificationEvents.NotificationsChanged());
}
