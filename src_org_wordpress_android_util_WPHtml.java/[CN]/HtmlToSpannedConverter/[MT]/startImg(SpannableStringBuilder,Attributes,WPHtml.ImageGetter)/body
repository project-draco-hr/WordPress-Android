{
  String src=attributes.getValue("android-uri");
  Bitmap resizedBitmap=null;
  Display display=((WindowManager)ctx.getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay();
  int width=display.getWidth();
  int height=display.getHeight();
  if (width > height)   width=height;
  ImageHelper ih=new ImageHelper();
  Map<String,Object> mediaData=ih.getImageBytesForPath(src,ctx);
  if (mediaData != null) {
    BitmapFactory.Options opts=new BitmapFactory.Options();
    opts.inJustDecodeBounds=true;
    byte[] bytes=(byte[])mediaData.get("bytes");
    BitmapFactory.decodeByteArray(bytes,0,bytes.length,opts);
    float conversionFactor=0.25f;
    if (opts.outWidth > opts.outHeight)     conversionFactor=0.40f;
    byte[] finalBytes=ih.createThumbnail((byte[])mediaData.get("bytes"),String.valueOf((int)(width * conversionFactor)),(String)mediaData.get("orientation"),true);
    if (finalBytes == null)     return;
    resizedBitmap=BitmapFactory.decodeByteArray(finalBytes,0,finalBytes.length);
    int len=text.length();
    text.append("\uFFFC");
    Uri curStream=Uri.parse(src);
    if (curStream == null) {
      return;
    }
    WPImageSpan is=new WPImageSpan(ctx,resizedBitmap,curStream);
    MediaFile mf=WordPress.wpDB.getMediaFile(src,post);
    if (mf != null) {
      is.setTitle(mf.getTitle());
      is.setDescription(mf.getDescription());
      is.setCaption(mf.getCaption());
      is.setFeatured(mf.isFeatured());
      is.setFeaturedInPost(mf.isFeaturedInPost());
      is.setHorizontalAlignment(mf.getHorizontalAlignment());
      is.setImageSource(curStream);
      is.setWidth(mf.getWidth());
      is.setVideo(mf.isVideo());
      text.setSpan(is,len,text.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
      AlignmentSpan.Standard as=new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
      text.setSpan(as,text.getSpanStart(is),text.getSpanEnd(is),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
    }
  }
 else   if (post != null) {
    if (post.isLocalDraft()) {
      if (attributes != null) {
        text.append("<img");
        for (int i=0; i < attributes.getLength(); i++) {
          String aName=attributes.getLocalName(i);
          if ("".equals(aName))           aName=attributes.getQName(i);
          text.append(" ");
          text.append(aName + "=\"" + attributes.getValue(i)+ "\"");
        }
        text.append(" />\n");
      }
    }
  }
}
