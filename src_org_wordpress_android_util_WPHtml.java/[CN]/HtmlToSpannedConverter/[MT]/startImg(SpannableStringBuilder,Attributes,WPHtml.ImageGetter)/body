{
  String src=attributes.getValue("android-uri");
  Bitmap resizedBitmap=null;
  Uri curStream=null;
  if (src != null) {
    curStream=Uri.parse(src);
  }
  if (curStream != null) {
    String[] projection=new String[]{Images.Thumbnails._ID,Images.Thumbnails.DATA,Images.Media.ORIENTATION};
    String orientation="", path="";
    Cursor cur=ctx.getContentResolver().query(curStream,projection,null,null,null);
    File jpeg=null;
    if (cur != null) {
      String thumbData="";
      if (cur.moveToFirst()) {
        int dataColumn, orientationColumn;
        dataColumn=cur.getColumnIndex(Images.Media.DATA);
        orientationColumn=cur.getColumnIndex(Images.Media.ORIENTATION);
        thumbData=cur.getString(dataColumn);
        orientation=cur.getString(orientationColumn);
      }
      jpeg=new File(thumbData);
      path=thumbData;
    }
 else {
      path=curStream.toString().replace("file://","");
      jpeg=new File(curStream.toString().replace("file://",""));
    }
    byte[] finalBytes=null;
    byte[] bytes=new byte[(int)jpeg.length()];
    DataInputStream in=null;
    try {
      in=new DataInputStream(new FileInputStream(jpeg));
    }
 catch (    FileNotFoundException e) {
      e.printStackTrace();
    }
    try {
      in.readFully(bytes);
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
    try {
      in.close();
    }
 catch (    IOException e) {
      e.printStackTrace();
    }
    ImageHelper ih=new ImageHelper();
    if (orientation == "") {
      orientation=ih.getExifOrientation(path,orientation);
    }
    Display display=((WindowManager)ctx.getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay();
    int width=display.getWidth();
    finalBytes=ih.createThumbnail(bytes,String.valueOf(width / 2),orientation,true);
    resizedBitmap=BitmapFactory.decodeByteArray(finalBytes,0,finalBytes.length);
    int len=text.length();
    text.append("\uFFFC");
    WPImageSpan is=new WPImageSpan(ctx,resizedBitmap,curStream);
    WordPressDB wpDB=new WordPressDB(ctx);
    MediaFile mf=wpDB.getMediaFile(ctx,src,post);
    if (mf != null) {
      is.setTitle(mf.getTitle());
      is.setDescription(mf.getDescription());
      is.setCaption(mf.getCaption());
      is.setFeatured(mf.isFeatured());
      is.setHorizontalAlignment(mf.getHorizontalAlignment());
      is.setImageSource(curStream);
      is.setWidth(mf.getWidth());
    }
    text.setSpan(is,len,text.length(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
  }
 else {
    if (attributes != null) {
      text.append("<img");
      for (int i=0; i < attributes.getLength(); i++) {
        String aName=attributes.getLocalName(i);
        if ("".equals(aName))         aName=attributes.getQName(i);
        text.append(" ");
        text.append(aName + "=\"" + attributes.getValue(i)+ "\"");
      }
      text.append(" />\n");
    }
  }
}
